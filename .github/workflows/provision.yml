name: Infrastructure Provisioning

on:
  workflow_call:
    inputs:
      environment:
        required: true
        type: string
    secrets:
      # AWS Backend (S3 + DynamoDB for Terraform state)
      AWS_ACCESS_KEY_ID: 
        required: true
      AWS_SECRET_ACCESS_KEY:
        required: true
      AWS_REGION:
        required: true
      AWS_STATE_BUCKET:
        required: true
      AWS_LOCK_TABLE:
        required: true
      AWS_STATE_BUCKET_KEY:
        required: true
      # OCI Provider
      OCI_TENANCY_OCID:
        required: true
      OCI_USER_OCID:
        required: true
      OCI_FINGERPRINT:
        required: true
      OCI_PRIVATE_KEY:
        required: true
      OCI_REGION:
        required: true
      OCI_COMPARTMENT_OCID:
        required: true
      # Optional Terraform variables
      OCI_INSTANCE_SHAPE:
        required: false
      OCI_DOMAIN:
        required: false
      OCI_SUBDOMAIN:
        required: false
    outputs:
      public_ip:
        description: "Public IP address of the provisioned VM"
        value: ${{ jobs.terraform.outputs.public_ip }}
      ssh_public_key:
        description: "SSH public key for the VM"
        value: ${{ jobs.terraform.outputs.ssh_public_key }}
      ssh_private_key:
        description: "SSH private key for the VM (sensitive)"
        value: ${{ jobs.terraform.outputs.ssh_private_key }}
      dns_record:
        description: "DNS record information for GoDaddy (JSON)"
        value: ${{ jobs.terraform.outputs.dns_record }}
jobs:
  terraform:
    runs-on: ubuntu-latest
    environment: ${{ inputs.environment }}

    env:
      AWS_REGION: ${{ secrets.AWS_REGION }}
      BUCKET: ${{ secrets.AWS_STATE_BUCKET }}
      TABLE: ${{ secrets.AWS_LOCK_TABLE }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Install Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.7.0

      - name: Setup Terraform backend (S3 + DynamoDB)
        run: |
          chmod +x ./bin/bootstrap_backend.sh
          ./bin/bootstrap_backend.sh "$BUCKET" "$TABLE" "$AWS_REGION"

      - name: Create OCI private key file
        run: |
          mkdir -p ~/.oci
          echo "${{ secrets.OCI_PRIVATE_KEY }}" > ~/.oci/oci_api_key.pem
          chmod 600 ~/.oci/oci_api_key.pem

      - name: Terraform Init
        run: |
          terraform -chdir=./infra/prod init \
          -backend-config="bucket=$BUCKET" \
          -backend-config="dynamodb_table=$TABLE" \
          -backend-config="region=$AWS_REGION" \
          -backend-config="key=${{ secrets.AWS_STATE_BUCKET_KEY }}"

      - name: Terraform Validate
        run: terraform -chdir=./infra/prod validate

      - name: Terraform Plan
        run: |
          PLAN_ARGS="-var=tenancy_ocid=${{ secrets.OCI_TENANCY_OCID }} \
          -var=user_ocid=${{ secrets.OCI_USER_OCID }} \
          -var=fingerprint=${{ secrets.OCI_FINGERPRINT }} \
          -var=private_key_path=~/.oci/oci_api_key.pem \
          -var=region=${{ secrets.OCI_REGION }} \
          -var=compartment_ocid=${{ secrets.OCI_COMPARTMENT_OCID }}"
          
          if [ -n "${{ secrets.OCI_INSTANCE_SHAPE }}" ]; then
            PLAN_ARGS="$PLAN_ARGS -var=instance_shape=${{ secrets.OCI_INSTANCE_SHAPE }}"
          fi
          
          if [ -n "${{ secrets.OCI_DOMAIN }}" ]; then
            PLAN_ARGS="$PLAN_ARGS -var=domain=${{ secrets.OCI_DOMAIN }}"
          fi
          
          if [ -n "${{ secrets.OCI_SUBDOMAIN }}" ]; then
            PLAN_ARGS="$PLAN_ARGS -var=subdomain=${{ secrets.OCI_SUBDOMAIN }}"
          fi
          
          terraform -chdir=./infra/prod plan -out=tfplan $PLAN_ARGS

      - name: Terraform Apply
        run: terraform -chdir=./infra/prod apply -auto-approve tfplan

      - name: Extract Terraform Outputs
        id: terraform_outputs
        run: |
          PUBLIC_IP=$(terraform -chdir=./infra/prod output -raw public_ip)
          SSH_PUBLIC_KEY=$(terraform -chdir=./infra/prod output -raw ssh_public_key)
          SSH_PRIVATE_KEY=$(terraform -chdir=./infra/prod output -raw ssh_private_key)
          DNS_RECORD=$(terraform -chdir=./infra/prod output -json dns_record_for_godaddy)
          
          echo "public_ip=$PUBLIC_IP" >> $GITHUB_OUTPUT
          echo "ssh_public_key<<EOF" >> $GITHUB_OUTPUT
          echo "$SSH_PUBLIC_KEY" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          echo "ssh_private_key<<EOF" >> $GITHUB_OUTPUT
          echo "$SSH_PRIVATE_KEY" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          echo "dns_record<<EOF" >> $GITHUB_OUTPUT
          echo "$DNS_RECORD" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

    outputs:
      public_ip: ${{ steps.terraform_outputs.outputs.public_ip }}
      ssh_public_key: ${{ steps.terraform_outputs.outputs.ssh_public_key }}
      ssh_private_key: ${{ steps.terraform_outputs.outputs.ssh_private_key }}
      dns_record: ${{ steps.terraform_outputs.outputs.dns_record }}